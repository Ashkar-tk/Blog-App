{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blog Home | MyBlogSpace</title>

 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- FIXED: Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" />

<link href="{% static 'css/reader_home.css' %}" rel="stylesheet">

<style>



  /* Unified height */
.search-input,
.search-icon-btn,
.category-select,
.filter-btn {
    height: 45px; 
}
  /* Search input */
.search-input {
    background-color: #000;
    color: #fff;
    border: 1px solid #00c2cb;
    border-radius: 10px;
}

/* Search icon button */
.search-icon-btn {
    background-color: #000;
    border: 1px solid #00c2cb ;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.search-icon-btn i {
    color: #00c2cb;
    font-size: 18px;
}

.search-icon-btn:hover{
  border: 1px solid #00c2cb;
}

/* Category dropdown */
.category-select {
    background-color: #000;
    color: #fff;
    border: 1px solid #00c2cb;
    border-radius: 10px;
}

/* Apply filter button */
.filter-btn {
    border: 1px solid #00c2cb;
    color: #00c2cb;
    background-color: transparent;
    border-radius: 10px;
}

.filter-btn:hover {
    background-color: #00c2cb;
    color: #000;
}
</style>

</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="bi bi-journal-text"></i> MyBlogSpace</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
        <span class="navbar-toggler-icon"></span>
      </button>
  
      <div class="collapse navbar-collapse" id="navmenu">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a href="{% url 'reader-home' %}" class="nav-link">Home</a></li>
          <li class="nav-item"><a href="{% url 'render-writer' %}" class="nav-link">Writers</a></li>
          <!-- <li class="nav-item"><a href="{% url 'bookmarks' %}" class="nav-link">Bookmarks</a></li> -->
          <li class="nav-item"><a href="{% url 'forgot-password' %}" class="nav-link">Forgott Password</a></li>
          <li class="nav-item"><a href="{% url 'logout' %}" class="nav-link">Logout</a></li>
        </ul>
  
  
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle"></i> My Activity
          </a>
          <ul class="dropdown-menu dropdown-menu-end" style="background-color:black;">
            <li><a class="dropdown-item text-info" href="{% url 'liked_blogs' %}">
                <i class="bi bi-heart-fill text-danger"></i> Liked Blogs
              </a></li>
  
            <li><a class="dropdown-item text-info" href="{% url 'disliked_blogs' %}">
                <i class="bi bi-heartbreak-fill text-secondary"></i> Disliked Blogs
              </a></li>
  
            <li>
              <hr class="dropdown-divider bg-success">
            </li>
  
            <li><a class="dropdown-item text-info" href="{% url 'bookmarks' %}">
                <i class="bi bi-bookmark-fill text-light"></i> Bookmarks
              </a></li>
          </ul>
        </li>
  
      </div>
    </div>
  </nav>


  <!-- Blog Section -->
  <div class="container mt-5 mb-5">
    <h2><i class="bi bi-pencil-square"></i> Latest Blogs</h2>
    <div class="row g-2 align-items-center search-bar mb-4">

  <!-- SEARCH FORM -->
  <form method="GET" action="" class="col-md-6 d-flex gap-2">

    <input 
    type="text"
    name="q"
    id="search-input"
    class="form-control search-input"
    placeholder="Search blogs..."
    autocomplete="off"
    value="{{ query|default:'' }}"
  />

  <!-- Suggestions Box -->
  <ul id="suggestions-box" class="list-group position-absolute w-60 d-none"></ul>

    <button type="submit" class="btn search-icon-btn">
      <i class="bi bi-search"></i>
    </button>

  </form>

  <!-- CATEGORY FORM -->
  <form method="GET" action="" class="col-md-6 d-flex gap-2">

    <select name="category" class="form-select category-select">
      <option value="" disabled selected  >All Categories</option>

      {% for cat in category %}
        <option value="{{ cat }}"
          {% if selected_category == cat %}selected{% endif %}>
          {{ cat }}
        </option>
      {% endfor %}
    </select>

    <!-- Keep search when filtering category (optional) -->
    {% if query %}
      <input type="hidden" name="q" value="{{ query }}">
    {% endif %}

    <button type="submit" class="btn filter-btn">
      Apply
    </button>

  </form>

</div>
    <div class="row g-4">

      <!-- Blog 1 -->
      {% for blog in blogs %}
      <div class="col-md-6 col-lg-4">
        <div class="card blog-card">

        <span class="bookmark-icon {% if blog.id in bookmarked_ids %}saved{% endif %}"
      data-blog-id="{{ blog.id }}">

    {% if blog.id in bookmarked_ids %}
        <i class="bi bi-bookmark-fill"></i>
    {% else %}
        <i class="bi bi-bookmark"></i>
    {% endif %}

</span>



          <div class="card-body">
            <h5 class="card-title">{{ blog.blog_title }}</h5>

            <p class="writer-name">
              <a href="#">
                {% if blog.writer.profile and blog.writer.profile.url %}
                <img src="{{ blog.writer.profile.url }}" alt="Writer Profile" class="writer-profile-icon">
                {% else %}
                <img src="{% static 'images/Writer_default.png' %}" alt="Default Writer" class="writer-profile-icon">
                {% endif %}
              </a>
              by <b>{{ blog.writer.first_name }}</b>
            </p>

            <div class="row blog-meta-row mb-2">
              <div class="col-6">
                <span class="blog-meta">
                  <i class="bi bi-tag"></i> {{ blog.category }}
                </span>
              </div>
            
              <div class="col-6 text-end">
                <span class="blog-meta">
                  <i class="bi bi-clock"></i> {{ blog.reading_time }} min read
                </span>
              </div>
            </div>

              

            
            <p class="blog-meta"><i class="bi bi-calendar3"></i>  {{ blog.created_at }}</p>

            {% if blog.image and blog.image.url %}
            <img src="{{ blog.image.url }}" class="blog-img" alt="Blog Image">
            {% else %}
            <img src="{% static 'images/blog_default.png' %}" class="blog-img" alt="Default Blog Image">
            {% endif %}


            <p class="card-text">
              {{ blog.content|truncatechars:150 }}....
            <a class="" href="{% url 'reader-blog_detail' blog.id %}">Read...</a></p>



<div class="blog-actions d-flex justify-content-start gap-4"
     data-blog-id="{{ blog.id }}">

    <div class="action-item like d-flex align-items-center gap-2"
         data-action="like">
        <i class="bi bi-heart action-icon"></i>
        <span class="action-label like-count">{{ blog.like_count }}</span>
    </div>

    <div class="action-item dislike d-flex align-items-center gap-2"
         data-action="dislike">
        <i class="bi bi-hand-thumbs-down action-icon"></i>
        <span class="action-label dislike-count">{{ blog.dislike_count }}</span>
    </div>

    <div class="action-item comment d-flex align-items-center gap-2">
        <a href="{% url 'reader-blog_detail' blog.id %}"> <i class="bi bi-chat-left-text action-icon"></i></a>
        <span class="action-label">{{ blog.comments.count }}</span>
    </div>

    <div class="action-item share d-flex align-items-center gap-2"
         onclick="shareBlog('{{ request.build_absolute_uri }}')">
        <i class="bi bi-share-fill action-icon"></i>
        <span class="action-label">Share</span>
    </div>  
</div>





          
          
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
<script>
document.querySelectorAll('.action-item.like, .action-item.dislike')
.forEach(item => {
    item.addEventListener('click', function () {

        const parent = this.closest('.blog-actions');
        const blogId = parent.dataset.blogId;
        const action = this.dataset.action;

        fetch(`/blog/${blogId}/react/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `action=${action}`
        })
        .then(res => res.json())
        .then(data => {
            parent.querySelector('.like-count').innerText = data.likes;
            parent.querySelector('.dislike-count').innerText = data.dislikes;
        });
    });
});

function shareBlog(url) {
    navigator.clipboard.writeText(url);
    alert("Blog link copied!");
}


// for bookmark

document.querySelectorAll('.bookmark-icon').forEach(icon => {
    icon.addEventListener('click',function(){
        const blogId=this.dataset.blogId;
        const iconTag=this.querySelector('i');

        fetch(`/blog/${blogId}/bookmark/`,{
            method:'POST',
            headers:{
                'X-CSRFToken':'{{ csrf_token }}'
            }
        })
        .then(res=>res.json())
        .then(data=>{

            if(data.saved){
                this.classList.add('saved');
                iconTag.classList.remove('bi-bookmark');
                iconTag.classList.add('bi-bookmark-fill');
            }else{
                this.classList.remove('saved');
                iconTag.classList.remove('bi-bookmark-fill');
                iconTag.classList.add('bi-bookmark');
            }

        });
    });
});


// real time


const searchInput=document.getElementById("search-input");
const suggestionsBox=document.getElementById("suggestions-box");

searchInput.addEventListener("keyup",function(){
    const query=this.value.trim();

    if(query.length<2) {
        suggestionsBox.classList.add("d-none");//hide default
        suggestionsBox.innerHTML="";//clear old suggessions
        return;//stop here
    }
    fetch(`/search-suggestions/?q=${query}`)//sends request to django ,,q=python
        .then(response=>response.json())
        .then(data=>{
            suggestionsBox.innerHTML="";
            if(data.length===0){
                suggestionsBox.classList.add("d-none");
                return;
            }

            data.forEach(item => {
                const li=document.createElement("li");
                li.className="list-group-item list-group-item-action";
                li.textContent=item;

                li.onclick=()=>{
                    searchInput.value=item;
                    suggestionsBox.classList.add("d-none");
                };

                suggestionsBox.appendChild(li);
            });

            suggestionsBox.classList.remove("d-none");
        });
});

</script>


</body>
</html>
